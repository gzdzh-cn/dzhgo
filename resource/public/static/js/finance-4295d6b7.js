import{i as e}from"./index.umd.min-ead3793b.js";import{u as l,e as o}from"./browser-f4ca2ed3.js";import"./vue-echarts-bffdbdc9.js";import"./element-plus-e665fdbc.js";import"./store-acbd10e3.js";import"./index-ecdd2562.js";import{u as a}from"./index-1fe6d5c5.js";import{X as r}from"./@element-plus.icons-vue-e9c91902.js";import{d as t}from"./dayjs-f8876307.js";import{d as n,e as p,W as i,o as s,I as u,J as d,a as m,b as c,N as v}from"./@vue.runtime-core-6173334e.js";import{r as y}from"./@vue.reactivity-54707199.js";import{L as f}from"./@vue.shared-0cc4c744.js";import"./axios-bb93cf32.js";import"./vue-21f38777.js";import"./@vue.runtime-dom-532828a1.js";import"./monaco-editor-c28fb00f.js";import"./nprogress-27d9be10.js";import"./lodash-es-fd5b777b.js";import"./vue-router-25454f45.js";import"./@vueuse.core-cb7ad152.js";import"./@vueuse.shared-feb01f08.js";import"./pinia-77f7f468.js";import"./vue-demi-71ba0ef2.js";import"./mockjs-005b47e8.js";import"./resize-detector-2312ef2b.js";import"./echarts-e550b62f.js";import"./tslib-a4e99503.js";import"./zrender-f72fb7be.js";import"./@popperjs.core-b696b006.js";import"./@ctrl.tinycolor-a951068a.js";import"./async-validator-ff95bfc9.js";import"./memoize-one-63ab667a.js";import"./escape-html-1935ddb3.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui.dom-92665be4.js";import"./@floating-ui.core-c1b3624a.js";const b={style:{padding:"10px 10px 0px 20px",display:"flex","flex-wrap":"wrap","row-gap":"10px"}},j=m("div",{class:"divider"},null,-1),h=["innerHTML"],x=n({name:"crm-finance"}),g=n({...x,setup(n){const{user:x}=l(),g=y(1!=x.info.id),{dict:C}=o(),{service:w}=a(),M=y("in"),Y=y(!1),k=()=>{Y.value=!Y.value};p((()=>{N()}));const D=e.useUpsert({items:[{label:"下单者",prop:"uid",required:!0,value:x.info.id,hidden:()=>1!=x.info.id,component:{name:"el-select",options:[],props:{}}},{label:"项目订单",span:12,prop:"orderCode",component:{name:"slot-orderCode"}},()=>({label:"收款",prop:"receiveMoney",span:12,hidden:({scope:e})=>{var l;return"add"==(null==(l=D.value)?void 0:l.mode)?"in"!==M.value:"in"!==e.type},component:{name:"el-input-number",props:{suffixIcon:r,min:0}}}),()=>({label:"支出",prop:"expenditureMoney",span:12,hidden:({scope:e})=>{var l;return"add"==(null==(l=D.value)?void 0:l.mode)?"out"!==M.value:"out"!==e.type},component:{name:"el-input-number",props:{suffixIcon:r,min:0}}}),{label:"种类",prop:"species",span:12,value:"company",component:{name:"el-select",options:C.get("species")}},{label:"结算方式",prop:"paytype",span:12,required:!0,component:{name:"el-select",options:C.get("paytype")}},{label:"结算日期",prop:"payDate",span:12,required:!0,value:t().format("YYYY-MM-DD"),component:{name:"el-date-picker",props:{type:"date",valueFormat:"YYYY-MM-DD"}}},{label:"备注",prop:"remark",component:{name:"el-input",props:{type:"textarea",rows:4}}}],async onOpen(e){var l,o,a,r,t,n,p,i;if(1==x.info.id){const e=await w.base.sys.user.list();null==(l=D.value)||l.setOptions("uid",e.map((e=>({label:e.nickName||"",value:e.id||""}))))}"update"==(null==(o=D.value)?void 0:o.mode)&&await W(e.orderCode),"add"==(null==(a=D.value)?void 0:a.mode)&&("in"==M.value&&(null==(r=D.value)||r.setTitle("新增收入")),"out"==M.value&&(null==(t=D.value)||t.setTitle("新增支出"))),"update"==(null==(n=D.value)?void 0:n.mode)&&(M.value=e.type,"in"==e.type&&(null==(p=D.value)||p.setTitle("编辑收入")),"out"==e.type&&(null==(i=D.value)||i.setTitle("编辑支出")))},onSubmit(e,{next:l}){var o,a,r,t;let n={projectNum:null==(o=e.orderCode)?void 0:o.split("-")[0],type:M.value,incomeAndOut:e.receiveMoney,orderId:null==(a=S.value[e.orderCode])?void 0:a.id,orderType:null==(r=S.value[e.orderCode])?void 0:r.orderType};e.expenditureMoney&&(n.incomeAndOut="-"+e.expenditureMoney),1!=(null==(t=x.info)?void 0:t.id)&&(n.uid=x.info.id),l({...e,...n})}}),T=e.useTable({columns:[{type:"selection"},{label:"下单者",prop:"userName",hidden:g},{label:"项目订单",prop:"orderCode"},{label:"收支",prop:"incomeAndOut"},{label:"种类",prop:"species",dict:{text:!0,separator:"",options:C.get("species").value}},{label:"结算方式",prop:"paytype",dict:{text:!0,separator:"",options:C.get("paytype").value}},{label:"结算日期",prop:"payDate",component:{name:"cl-date-text",props:{format:"YYYY-MM-DD"}}},{label:"备注",prop:"remark",showOverflowTooltip:!0,minWidth:150},{type:"op",buttons:["edit","delete"]}]}),_=e.useCrud({service:w.crm.finance,async onRefresh(e,{next:l,render:o}){let a;I.value?(I.value=!1,a=await w.crm.finance.list({size:1e4,month:1})):a=await w.crm.finance.list(e),o(a)}});p((()=>{O({size:1e4,month:1})}));const O=e=>{var l;null==(l=_.value)||l.refresh(e)},A=y(),N=async()=>{const e=(await w.base.sys.user.list()).map((e=>({label:e.nickName||"",value:e.id||""})));return A.value=e,A},z=e.useAdvSearch({items:[()=>({label:"下单者",prop:"uid",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...A.value]}}}),{label:"月份",prop:"month",component:{name:"cl-select",props:{options:[{label:"全部",value:""},{label:"近一个月",value:"1"},{label:"近二个月",value:"2"},{label:"近三个月",value:"3"},{label:"近半年",value:"6"},{label:"近一年",value:"12"}]}}},{label:"种类",prop:"species",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("species").value]}}},{label:"收支类型",prop:"type",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("type").value]}}},{label:"结算方式",prop:"paytype",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("paytype").value]}}},{label:"时间",prop:"dateTime",component:{name:"el-date-picker",props:{type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",value:"YYYY-MM-DD",valueFormat:"YYYY-MM-DD",disabledDate:e=>e.getTime()>Date.now()}}}]}),I=y(!1),F=()=>{var e;I.value=!0,null==(e=_.value)||e.refresh()},L=({column:e})=>"expenditureMoney"==e.property?"expenditureMoney":"receiveMoney"==e.property?"receiveMoney":void 0,q=e=>{var l;M.value=e,null==(l=D.value)||l.add()},S=y({}),U=y([]),V=y(!1),W=async e=>{if(""!==e){V.value=!0;const l=await w.crm.order.list({keyWord:e});V.value=!1,U.value=l.map((e=>{S.value[e.orderCode]=e;const l=$(e.orderType);return{label:(null==l?void 0:l.label)+"-"+e.orderCode,value:e.orderCode}}))}},$=e=>{const l=C.get("orderType").value.filter((l=>l.value==e));if(l.length>0)return l[0];const o=C.get("subOrderType").value.filter((l=>l.value==e));return o.length>0?o[0]:{}},H=y(),J=e=>{H.value=e},K=({row:e,column:l,rowIndex:o,columnIndex:a})=>{var r;if(o===Number(null==(r=T.value)?void 0:r.data.length)){if(0===a)return[1,2];if(1===a)return[0,0]}},P=e=>{const{columns:l,data:o}=e;return["","合计","",`￥ ${o.reduce(((e,l)=>parseFloat(e+Number(l.incomeAndOut))),0).toFixed(2)}`]},B=e=>{let l;return null==e||e.expenditureMoney,l="in"==(null==e?void 0:e.type)?`<span style="color:#f74848"> 收 : ${null==e?void 0:e.incomeAndOut} </span> 元`:`<span style="color:#4165d7"> 支 : ${null==e?void 0:e.incomeAndOut}  </span>  元`,l};return(e,l)=>{const o=i("cl-refresh-btn"),a=i("cl-multi-delete-btn"),r=i("cl-search-key"),t=i("cl-adv-btn"),n=i("cl-flex1"),p=i("DArrowLeft"),y=i("el-icon"),x=i("el-button"),g=i("cl-table"),C=i("cl-row"),w=i("el-select-v2"),M=i("cl-upsert"),O=i("cl-adv-search"),A=i("cl-crud");return s(),u(A,{ref_key:"Crud",ref:_},{default:d((()=>[m("div",b,[c(o),c(a,{style:{"margin-right":"10px"}}),c(r),c(t),c(n),c(x,{plain:"",onClick:k,style:{"margin-right":"10px"}},{default:d((()=>[c(y,null,{default:d((()=>[c(p)])),_:1}),v(" "+f(Y.value?"收起":"展开"),1)])),_:1}),c(x,{type:"primary",onClick:l[0]||(l[0]=e=>q("in"))},{default:d((()=>[v("新增收入")])),_:1}),c(x,{type:"danger",onClick:l[1]||(l[1]=e=>q("out"))},{default:d((()=>[v("新增支出")])),_:1}),c(x,{test:"",bg:"",onClick:F},{default:d((()=>[v("清除条件")])),_:1})]),j,c(C,null,{default:d((()=>[c(g,{ref_key:"Table",ref:T,border:!1,cellClassName:L,headerCellClassName:L,"span-method":K,"summary-method":P,"show-summary":"",onSelectionChange:J},{"column-incomeAndOut":d((({scope:e})=>[m("div",{style:{"text-align":"left"},innerHTML:B(e.row)},null,8,h)])),_:1},512)])),_:1}),c(C,null,{default:d((()=>[c(n)])),_:1}),c(M,{ref_key:"Upsert",ref:D},{"slot-orderCode":d((({scope:e})=>[c(w,{modelValue:e.orderCode,"onUpdate:modelValue":l=>e.orderCode=l,filterable:"",remote:"","remote-method":W,clearable:"",options:U.value,loading:V.value,placeholder:"请输入订单号"},null,8,["modelValue","onUpdate:modelValue","options","loading"])])),_:1},512),c(O,{ref_key:"AdvSearch",ref:z},null,512)])),_:1},512)}}});export{g as default};
