import{i as e}from"./index.umd.min-ead3793b.js";import{u as o,e as r}from"./browser-f4ca2ed3.js";import"./vue-echarts-bffdbdc9.js";import{e as l}from"./element-plus-e665fdbc.js";import"./store-acbd10e3.js";import"./index-ecdd2562.js";import{u as t}from"./index-1fe6d5c5.js";import{d as s,W as a,o as i,I as p,J as d,a as n,b as u,N as m}from"./@vue.runtime-core-6173334e.js";import{r as c,h as v,u as b}from"./@vue.reactivity-54707199.js";import{L as f}from"./@vue.shared-0cc4c744.js";import"./axios-bb93cf32.js";import"./vue-21f38777.js";import"./@vue.runtime-dom-532828a1.js";import"./monaco-editor-c28fb00f.js";import"./nprogress-27d9be10.js";import"./lodash-es-fd5b777b.js";import"./vue-router-25454f45.js";import"./@vueuse.core-cb7ad152.js";import"./@vueuse.shared-feb01f08.js";import"./pinia-77f7f468.js";import"./vue-demi-71ba0ef2.js";import"./mockjs-005b47e8.js";import"./resize-detector-2312ef2b.js";import"./echarts-e550b62f.js";import"./tslib-a4e99503.js";import"./zrender-f72fb7be.js";import"./@element-plus.icons-vue-e9c91902.js";import"./@popperjs.core-b696b006.js";import"./@ctrl.tinycolor-a951068a.js";import"./dayjs-f8876307.js";import"./async-validator-ff95bfc9.js";import"./memoize-one-63ab667a.js";import"./escape-html-1935ddb3.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui.dom-92665be4.js";import"./@floating-ui.core-c1b3624a.js";const j={style:{padding:"10px 10px 0px 20px",display:"flex","flex-wrap":"wrap","row-gap":"10px"}},y=n("div",{class:"divider"},null,-1),g=s({name:"crm-dohistory"}),h=s({...g,setup(s){var g;const{service:h}=t(),{user:w}=o(),{dict:x}=r();c(1==(null==(g=w.info)?void 0:g.id));const C=e.useUpsert({items:[()=>({label:"会员",prop:"uid",span:12,required:!0,value:w.info.id,hidden:()=>1!=w.info.id,component:{name:"el-select",props:{}}}),{label:"标题",prop:"title",required:!0,component:{name:"el-input"}},()=>({label:"项目订单",span:12,prop:"orderCode",component:{name:"slot-orderCode"}}),()=>({label:"跟踪状态",prop:"state",span:12,hidden:()=>{var e;return"add"==(null==(e=C.value)?void 0:e.mode)},component:{name:"el-select",options:T}}),()=>({label:"图片上传",prop:"imgs",component:{name:"cl-upload",props:{type:"image",multiple:!0,showFileList:!0,draggable:!0,rename:!1}}}),()=>({label:"文件上传",prop:"files",component:{name:"cl-upload",props:{type:"file",multiple:!0,showFileList:!0,draggable:!0,rename:!1}}}),()=>({label:"备注",prop:"remark",component:{name:"el-input",props:{type:"textarea",rows:4}}})],async onOpened(e){var o,r,l,t,s,a,i,p,d,n;if(1==w.info.id){const e=await h.base.sys.user.list();null==(o=C.value)||o.setOptions("uid",e.map((e=>({label:e.nickName||"",value:e.id||""}))))}2==e.state&&"update"==(null==(r=C.value)?void 0:r.mode)&&(null==(l=C.value)||l.setProps("uid",{disabled:!0}),null==(t=C.value)||t.setProps("title",{disabled:!0}),null==(s=C.value)||s.setProps("imgs",{disabled:!0}),null==(a=C.value)||a.setProps("files",{disabled:!0}),null==(i=C.value)||i.setProps("orderCode",{disabled:!0}),null==(d=C.value)||d.setProps("state",{disabled:1!==(null==(p=w.info)?void 0:p.id)}),null==(n=C.value)||n.setProps("remark",{disabled:!0}))},onSubmit(e,{next:o}){var r,l,t;let s={orderId:null==(r=z.value[e.orderCode])?void 0:r.id,projectNum:null==(l=z.value[e.orderCode])?void 0:l.projectNum};1!=(null==(t=w.info)?void 0:t.id)&&(s.uid=w.info.id),o({...e,...s})}}),k=e.useTable({columns:[{type:"selection"},{label:"会员",prop:"userName"},{label:"标题",prop:"title",showOverflowTooltip:!0},{label:"项目订单",prop:"orderCode"},{label:"跟踪状态",prop:"state"},{label:"备注",prop:"remark",showOverflowTooltip:!0,minWidth:150},{label:"创建时间",prop:"createTime",component:{name:"cl-date-text",props:{format:"YYYY-MM-DD"}}},{type:"op",buttons:["edit","delete"]}]}),_=e.useCrud({service:h.crm.dohistory},(e=>{e.refresh()})),T=v([{label:"待处理",type:"danger",value:0},{label:"处理中",type:"warning",value:1},{label:"已完成",type:"success",value:2}]),P=e=>T.filter((o=>o.value==e))[0],z=c({}),N=c([]),O=c(!1),L=async e=>{if(""!==e){O.value=!0;const o=await h.crm.order.list({keyWord:e});O.value=!1,N.value=o.map((e=>{z.value[e.orderCode]=e;const o=U(e.orderType);return{label:(null==o?void 0:o.label)+"-"+e.orderCode,value:e.orderCode}}))}},U=e=>{const o=x.get("orderType").value.filter((o=>o.value==e));if(o.length>0)return o[0];const r=x.get("subOrderType").value.filter((o=>o.value==e));return r.length>0?r[0]:{}};return(e,o)=>{const r=a("cl-refresh-btn"),t=a("cl-add-btn"),s=a("cl-multi-delete-btn"),c=a("cl-search-key"),v=a("cl-flex1"),g=a("el-button"),w=a("el-popconfirm"),x=a("cl-table"),T=a("cl-row"),z=a("cl-pagination"),U=a("el-select-v2"),V=a("cl-upsert"),Y=a("cl-crud");return i(),p(Y,{ref_key:"Crud",ref:_},{default:d((()=>[n("div",j,[u(r),u(t),u(s,{style:{"margin-right":"10px"}}),u(c),u(v)]),y,u(T,null,{default:d((()=>[u(x,{ref_key:"Table",ref:k,border:!1},{"column-state":d((({scope:e})=>[u(w,{title:"跟踪状态更新?",onConfirm:o=>(e=>{if(2==e.state)return l({title:"提醒",message:"不可再更新",type:"warning"});e.state<2&&e.state++,h.crm.dohistory.update({...e}).then((()=>{l({title:"成功",message:"状态更新",type:"success"})}))})(e.row)},{reference:d((()=>[u(g,{text:"",bg:"",type:P(e.row.state).type},{default:d((()=>[m(f(P(e.row.state).label),1)])),_:2},1032,["type"])])),_:2},1032,["onConfirm"])])),_:1},512)])),_:1}),u(T,null,{default:d((()=>[u(v),u(z)])),_:1}),u(V,{ref_key:"Upsert",ref:C},{"slot-orderCode":d((({scope:e})=>{var o;return[u(U,{modelValue:e.orderCode,"onUpdate:modelValue":o=>e.orderCode=o,filterable:"",remote:"","remote-method":L,clearable:"",options:N.value,loading:O.value,placeholder:"请输入订单号",disabled:"add"!=(null==(o=b(C))?void 0:o.mode)},null,8,["modelValue","onUpdate:modelValue","options","loading","disabled"])]})),_:1},512)])),_:1},512)}}});export{h as default};
