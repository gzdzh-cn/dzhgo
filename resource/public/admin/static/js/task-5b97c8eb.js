import{w as e,v as a}from"./@vue.runtime-dom-532828a1.js";import{d as s}from"./vuedraggable-e5a8a8b4.js";import{d as l}from"./browser-5c66c964.js";import"./vue-echarts-cb4fb6c4.js";import{a as t,b as o}from"./element-plus-cc31d756.js";import"./store-acbd10e3.js";import"./index-95085aed.js";import{u as n}from"./index-6dccf6bb.js";import{i}from"./index.umd.min-b551c2d1.js";import{Q as r,d as p,U as c,V as u,W as d,X as m,Y as g,B as f}from"./@element-plus.icons-vue-2c9f4d7f.js";import{d as v,q as k,e as b,W as y,_ as h,o as j,c as _,b as x,J as C,a as w,F as z,U as V,K as T,N as D,M as F,al as q,ak as U,G as Y,I as A}from"./@vue.runtime-core-6173334e.js";import{h as M,u as E}from"./@vue.reactivity-54707199.js";import{L as G,p as I}from"./@vue.shared-0cc4c744.js";import{_ as N}from"./_plugin-vue_export-helper-1b428a4d.js";import"./sortablejs-1d1e1d3d.js";import"./axios-bb93cf32.js";import"./vue-21f38777.js";import"./monaco-editor-89e755bd.js";import"./nprogress-27d9be10.js";import"./lodash-es-fd5b777b.js";import"./vue-router-25454f45.js";import"./@vueuse.core-cb7ad152.js";import"./@vueuse.shared-feb01f08.js";import"./pinia-dc6d3ad6.js";import"./vue-demi-71ba0ef2.js";import"./mockjs-005b47e8.js";import"./resize-detector-2312ef2b.js";import"./echarts-e550b62f.js";import"./tslib-a4e99503.js";import"./zrender-f72fb7be.js";import"./@popperjs.core-b696b006.js";import"./@ctrl.tinycolor-a951068a.js";import"./dayjs-f8876307.js";import"./async-validator-ff95bfc9.js";import"./memoize-one-63ab667a.js";import"./escape-html-1935ddb3.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui.dom-92665be4.js";import"./@floating-ui.core-c1b3624a.js";const O=e=>(q("data-v-7b4626ac"),e=e(),U(),e),W={class:"view-task"},$={class:"box"},B={class:"header"},H={class:"label"},J={class:"num"},K=O((()=>w("span",{class:"flex1"},null,-1))),R={class:"op-btn"},L=O((()=>w("span",null,"刷新",-1))),Q=["onClick"],S=O((()=>w("span",null,"添加",-1))),X=["data-id","onContextmenu"],P={class:"h"},Z={class:"name"},ee={class:"remark"},ae={class:"f"},se={class:"date"},le=O((()=>w("span",{class:"start"},"进行中",-1))),te=O((()=>w("span",null,"...",-1))),oe=O((()=>w("span",{class:"stop"},"已停止",-1))),ne={class:"op"},ie=["onClick"],re=O((()=>w("span",null,"开始",-1))),pe=["onClick"],ce=O((()=>w("span",null,"暂停",-1))),ue=["onClick"],de=O((()=>w("span",null,"编辑",-1))),me=["onClick"],ge=O((()=>w("span",null,"查看日志",-1))),fe={key:0,class:"empty"},ve={class:"footer"},ke=["onClick"],be={class:"block _log"},ye={class:"header"},he=O((()=>w("span",{class:"label"},"日志",-1))),je={class:"num"},_e=O((()=>w("span",{class:"flex1"},null,-1))),xe={class:"op-btn"},Ce=O((()=>w("span",null,"刷新",-1))),we={class:"container","element-loading-text":"拼命加载中"},ze=["infinite-scroll-disabled"],Ve=["onClick"],Te={class:"h"},De={class:"name"},Fe={class:"f"},qe={key:0,class:"empty"},Ue=v({name:"task"}),Ye=N(v({...Ue,setup(v){const{refs:q,setRefs:U,service:N}=n(),O=M([{key:"sys",label:"系统任务",icon:"el-icon-s-tools",list:[],loading:!1,params:{type:0,status:1},pagination:{size:10,page:1,total:0}},{key:"user",label:"用户自定义任务",icon:"el-icon-user-solid",list:[],loading:!1,params:{type:1,status:1},pagination:{size:10,page:1,total:0}},{key:"stop",label:"已停止任务",list:[],loading:!1,params:{type:null,status:0},pagination:{size:10,page:1,total:0}}]),Ue=M({loading:!1,list:[],pagination:{size:10,page:1},params:{},filters:{status:[]},current:null}),Ye=M({options:{group:"Task",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:"._drag"}}),Ae=k((()=>N.task.info.permission));function Me(e,{list:a,pagination:s}){if(!e)return;const{page:l,size:t}=e.pagination,o=e.list.length,n=a.length;if(1==l)a.splice(0,n,...e.list);else{const s=n-n%t,l=s+o;a.splice(s,l,...e.list)}return o==t&&(e.pagination.page+=1),Object.assign(s,e.pagination),1!=l}function Ee(e,a){const{index:s,more:l}=a||{};(null==s?O.map(((e,a)=>a)):[s]).forEach((async a=>{const s=O[a];Object.assign(s.params,{...s.pagination,...e}),s.loading=!0;Me(await N.task.info.page(s.params),s),l||q[`${s.key}-scroller`].scroll({top:0,behavior:"smooth"}),s.loading=!1}))}const Ge=i.useForm();async function Ie(e){var a;const{id:s,type:l}=e||{};let o={type:l,service:"",name:"",cron:""};s&&(o=await N.task.info.info({id:s})),o.every&&(o.every/=1e3),o.limit||(o.limit=void 0),null==(a=Ge.value)||a.open({title:"编辑任务",width:"600px",props:{labelWidth:"80px"},items:[{label:"名称",prop:"name",component:{name:"el-input",props:{placeholder:"请输入名称"}},rules:{required:!0,message:"名称不能为空"}},{label:"类型",prop:"taskType",value:0,component:{name:"el-select",options:[{label:"cron",value:0},{label:"时间间隔",value:1}],props:{onChange(e){var a,s;0==e?null==(a=Ge.value)||a.setForm("every",void 0):null==(s=Ge.value)||s.setForm("cron",void 0)}}}},{label:"cron",prop:"cron",hidden:({scope:e})=>1==e.taskType,component:{name:"el-input",props:{placeholder:"* * * * * *"}},rules:{required:!0,message:"cron不能为空"}},{label:"间隔(秒)",prop:"every",hidden:({scope:e})=>0==e.taskType,component:{name:"el-input-number",props:{min:1,max:1e8}},rules:{required:!0,message:"执行间隔不能为空"}},{label:"service",prop:"service",component:{name:"el-input",props:{placeholder:"taskDemoService.test([1, 2])"}}},{label:"开始时间",prop:"startDate",hidden:({scope:e})=>1==e.taskType,component:{name:"el-date-picker",props:{type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss"}}},{label:"备注",prop:"remark",component:{name:"el-input",props:{type:"textarea"}}},{label:"状态",prop:"status",value:0,component:{name:"el-radio-group",options:[{label:"停止",value:0},{label:"运行",value:1}]}}],form:{...o},on:{submit:(e,{close:a,done:l})=>{e.limit||(e.limit=null),N.task.info[s?"update":"add"]({...o,...e,every:1e3*e.every}).then((()=>{Ee(),t.success("保存成功"),a()})).catch((e=>{t.error(e.message),l()}))}}})}function Ne({id:e,type:a}){N.task.info.start({id:e,type:a}).then((()=>{Ee()})).catch((e=>{t.error(e.message)}))}function Oe({id:e}){N.task.info.stop({id:e}).then((()=>{Ee()})).catch((e=>{t.error(e.message)}))}function We({to:e,item:a}){const s=e.getAttribute("data-status"),l=e.getAttribute("data-type"),t=a.getAttribute("data-id");0==s&&Oe({id:t}),1==s&&Ne({id:t,type:l})}async function $e(e,a){if(Ue.loading)return!1;if(!l(Ae.value.log))return!1;const{params:s,pagination:t}=Ue,{more:o}=a||{};Object.assign(s,{...t,...e}),Ue.loading=!0;Me(await N.task.info.log(s),Ue),o||q["log-scroller"].scroll({top:0,behavior:"smooth"}),Ue.loading=!1}function Be(){$e(null,{more:!0})}function He(e){Ue.current=e,$e({page:1,id:e.id})}function Je(){Ue.current=null,$e({page:1,id:null})}function Ke([e]){$e({page:1,status:void 0===e?1:0})}function Re(e,{id:a,status:s,type:n,name:r}){const p=[{label:"立即执行",perm:["once"],callback(e){!function({id:e}){N.task.info.once({id:e}).then((()=>{Ee()})).catch((e=>{t.error(e.message)}))}({id:a}),e()}},{label:"编辑",perm:["update","info"],callback(e){Ie({id:a,type:n}),e()}},{label:"删除",perm:["delete"],callback(e){!function({id:e}){o.confirm("此操作将永久删除该任务，是否继续？","提示",{type:"warning"}).then((()=>{N.task.info.delete({ids:[e]}).then((()=>{Ee()}))})).catch((()=>null))}({id:a}),e()}},{label:"查看日志",perm:["log"],callback(e){He({id:a,name:r}),e()}}];return 1==s?p.splice(1,0,{label:"暂停",perm:["stop"],callback(e){Oe({id:a,type:n}),e()}}):p.splice(1,0,{label:"开始",perm:["start"],callback(e){Ne({id:a,type:n}),e()}}),i.ContextMenu.open(e,{list:p.filter((e=>l({and:e.perm.map((e=>Ae.value[e]))})))}),!1}return b((()=>{Ee({page:1})})),(l,t)=>{const o=y("el-icon"),n=y("el-button"),i=y("el-checkbox"),v=y("el-checkbox-group"),k=y("el-scrollbar"),b=y("cl-form"),q=h("permission"),M=h("infinite-scroll"),N=h("loading");return j(),_("div",W,[x(k,null,{default:C((()=>[w("div",$,[(j(!0),_(z,null,V(O,((l,i)=>(j(),_("div",{key:i,class:I(["block",[`_${l.key}`]])},[w("div",B,[w("i",{class:I(["icon",l.icon])},null,2),w("span",H,G(l.label),1),w("span",J,"("+G(l.pagination.total)+")",1),K,w("ul",R,[T((j(),_("li",{class:"refresh-btn",onClick:t[0]||(t[0]=e=>Ee({page:1}))},[x(o,null,{default:C((()=>[x(E(r))])),_:1}),L])),[[q,E(Ae).delete]]),T((j(),_("li",{class:"add-btn",onClick:e=>Ie(l.params)},[x(o,null,{default:C((()=>[x(E(c))])),_:1}),S],8,Q)),[[q,E(Ae).add]])])]),w("div",{ref_for:!0,ref:E(U)(`${l.key}-scroller`),class:"container scroller1"},[x(E(s),Y({modelValue:O[i].list,"onUpdate:modelValue":e=>O[i].list=e},Ye.options,{tag:"ul","item-key":"id","data-type":l.params.type,"data-status":l.params.status,onEnd:We}),{item:C((({element:s})=>[(j(),_("li",{key:s.id,"data-id":s.id,class:"_drag",onContextmenu:e((e=>Re(e,s)),["stop","prevent"])},[w("div",P,[T(w("span",{class:"type _warning"},G(0===s.type?"系统":"用户"),513),[[a,0===s.status]]),w("span",Z,G(s.name),1)]),w("div",ee,G(s.remark),1),w("div",ae,[s.status?(j(),_(z,{key:0},[w("span",se,G(s.nextRunTime||"..."),1),le],64)):(j(),_(z,{key:1},[te,oe],64))]),w("div",ne,[0===s.status?(j(),_("div",{key:0,class:"op-item",onClick:e=>Ne(s)},[x(o,null,{default:C((()=>[x(E(u))])),_:1}),re],8,ie)):T((j(),_("div",{key:1,class:"op-item",onClick:e=>Oe(s)},[x(o,null,{default:C((()=>[x(E(d))])),_:1}),ce],8,pe)),[[q,E(Ae).stop]]),T((j(),_("div",{class:"op-item",onClick:e=>Ie(s)},[x(o,null,{default:C((()=>[x(E(m))])),_:1}),de],8,ue)),[[q,{and:[E(Ae).update,E(Ae).info]}]]),T((j(),_("div",{class:"op-item",onClick:e=>He(s)},[x(o,null,{default:C((()=>[x(E(g))])),_:1}),ge],8,me)),[[q,E(Ae).log]])])],40,X))])),header:C((()=>[0==O[i].list.length?(j(),_("div",fe," 暂无数据 ")):F("",!0)])),_:2},1040,["modelValue","onUpdate:modelValue","data-type","data-status"]),l.pagination.total>=l.pagination.size?(j(),A(n,{key:0,class:"more",text:"",onClick:e=>function(e){Ee(null,{index:e,more:!0})}(i)},{default:C((()=>[D("查看更多")])),_:2},1032,["onClick"])):F("",!0)],512),w("div",ve,[T((j(),_("button",{class:"btn-add",onClick:e=>Ie(l.params)},[x(o,null,{default:C((()=>[x(E(f))])),_:1})],8,ke)),[[q,E(Ae).add]])])],2)))),128)),T((j(),_("div",be,[w("div",ye,[he,w("span",je,"("+G(Ue.pagination.total)+")",1),_e,x(v,{modelValue:Ue.filters.status,"onUpdate:modelValue":t[1]||(t[1]=e=>Ue.filters.status=e),class:"status",onChange:Ke},{default:C((()=>[x(i,{label:0},{default:C((()=>[D("异常")])),_:1})])),_:1},8,["modelValue"]),w("ul",xe,[w("li",{onClick:t[2]||(t[2]=e=>$e({page:1}))},[x(o,null,{default:C((()=>[x(E(r))])),_:1}),Ce]),Ue.current?(j(),_("li",{key:0,class:"_current-log",onClick:Je},[w("span",null,G(Ue.current.name),1),x(o,null,{default:C((()=>[x(E(p))])),_:1})])):F("",!0)])]),T((j(),_("div",we,[T((j(),_("ul",{ref:E(U)("log-scroller"),class:"scroller1","infinite-scroll-disabled":Ue.list.length==Ue.pagination.total},[(j(!0),_(z,null,V(Ue.list,((e,a)=>(j(),_("li",{key:a,class:I({_error:0==e.status}),onClick:a=>{var s;(s=e)._expand=!s._expand}},[w("div",Te,[w("span",De,G(Number(a)+1)+" · "+G(e.taskName),1)]),w("div",{class:I(["remark",{_ellipsis:!e._expand}])},G(e.detail||"..."),3),w("div",Fe,[w("span",null,"执行时间："+G(e.createTime),1)])],10,Ve)))),128)),0==Ue.list.length?(j(),_("div",qe,"暂无数据")):F("",!0)],8,ze)),[[M,Be]])])),[[N,Ue.loading]])])),[[q,E(Ae).log]])])])),_:1}),x(b,{ref_key:"Form",ref:Ge},null,512)])}}}),[["__scopeId","data-v-7b4626ac"]]);export{Ye as default};
